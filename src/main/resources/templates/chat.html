<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Messages</title>
	<!--	<style>
		body {
			display: flex;
			justify-content: center;
			align-items: center;
			height: 100vh;
			margin: 0;
		}

		#chat-container {

			width: 100%;
			height: 100%;
			/* ƒê·∫∑t k√≠ch th∆∞·ªõc t·ªëi ƒëa cho khung chat */
			border: 1px solid #ccc;
			padding: 10px;
			overflow-y: auto;
			/* Hi·ªÉn th·ªã thanh cu·ªôn n·∫øu c√≥ nhi·ªÅu tin nh·∫Øn */
			background-color: #f5f5f5;

		}

		#chat-container::-webkit-scrollbar {
			display: none;
			/* ·∫®n thanh cu·ªôn cho tr√¨nh duy·ªát Chrome/Safari */
		}


		.sender1,
		.sender2 {
			margin-bottom: 10px;
			/* Kho·∫£ng c√°ch gi·ªØa c√°c tin nh·∫Øn */
			padding: 1px;
			border-radius: 8px;
			max-width: 70%;
			/* ƒê·∫∑t chi·ªÅu r·ªông t·ªëi ƒëa cho tin nh·∫Øn */
			word-wrap: break-word;
			/* Chia t·ª´ n·∫øu n·ªôi dung qu√° d√†i */

		}

		.sender1 {
			margin-left: 30%;
			text-align: right;
			padding-right: 10px;
			background-color: #98D8FF;
			align-self: flex-end;
		}

		.sender2 {
			text-align: left;
			padding-left: 10px;
			background-color: #FF9CF8;
			align-self: flex-start;
		}

		#messageForm {
			display: flex;
			margin-top: 10px;
			/* Kho·∫£ng c√°ch gi·ªØa khung chat v√† form g·ª≠i tin nh·∫Øn */
		}

		#content {
			flex: 1;
			/* ƒê·∫£m b·∫£o n√∫t g·ª≠i n·∫±m c·∫°nh √¥ nh·∫≠p tin nh·∫Øn */
			padding: 8px;
		}

		#sendButton {
			padding: 8px;
			cursor: pointer;
		}
	</style>-->
	<link rel="icon" href="images/fav.png" type="image/png" sizes="16x16">

	<link rel="stylesheet" href="css/main.min.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/color.css">
	<link rel="stylesheet" href="css/responsive.css">
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script type="module">
		import {initializeApp} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
		import {getAnalytics} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
		import {getDatabase, ref, onChildAdded, off} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

		const firebaseConfig = {
			apiKey: "AIzaSyAktz6fBLYH1GcUykJi8JF5WHwI6dNncuY",
			authDomain: "chatrealtime-7e7e8.firebaseapp.com",
			databaseURL: "https://chatrealtime-7e7e8-default-rtdb.firebaseio.com",
			projectId: "chatrealtime-7e7e8",
			storageBucket: "chatrealtime-7e7e8.appspot.com",
			messagingSenderId: "206925157542",
			appId: "1:206925157542:web:7e254501d41af820ed9067",
			measurementId: "G-0PDLXSS9SN"
		};

		const app = initializeApp(firebaseConfig);
		const analytics = getAnalytics(app);
		const conversationId = "[[${conversationId}]]";
		console.log('Conversation ID:', conversationId);

		const userid = document.getElementById('userid');
		const userCurrent = userid.value;

		const database = getDatabase(app);
		const messagesRef = ref(database, 'RealTimeChat/' + conversationId + '/messages');
		off(messagesRef);
		onChildAdded(messagesRef, (snapshot) => {
			const message = snapshot.val();
			const chatDiv = document.getElementById('chat');
			const newMessage = document.createElement('li');

			if (message.sender == userCurrent) {
				newMessage.className = 'me';
			} else {
				newMessage.className = 'you';
			}
			newMessage.innerHTML = `
                <div class="text-box"><p>${message.content}</p></div>
            `;
			chatDiv.appendChild(newMessage);
			newMessage.scrollIntoView({behavior: 'smooth'});
		});

		const uid = localStorage.getItem('recvId');
		const recvName = localStorage.getItem('recvName');
		// Set gi√° tr·ªã recvName v√†o n·ªôi dung c·ªßa th·∫ª p trong Receiver-Name
		document.getElementById('Receiver-Name').innerHTML = `<p><strong>${recvName}</strong></p>`;

		// Set gi√° tr·ªã uid v√†o thu·ªôc t√≠nh data-userid c·ªßa form
		$('#messageForm').attr('data-userid', uid);
	</script>
	<script>
		function sendMessage() {
			// L·∫•y gi√° tr·ªã uid t·ª´ thu·ªôc t√≠nh data-userid c·ªßa form
			var uid = $('#messageForm').data('userid');
			var contentValue = $('#content').val().trim();

			// Ki·ªÉm tra xem content c√≥ r·ªóng hay kh√¥ng
			if (contentValue !== '') {
				// Th√™m gi√° tr·ªã uid v√†o FormData
				var formData = $('#messageForm').serializeArray();
				formData.push({name: 'uid', value: uid});
				//var formData = $('#messageForm').serialize();

				$.ajax({
					type: 'POST',
					url: '/send',
					data: formData,
					success: function () {
						$('#content').val('');
					},
					error: function () {
						// Handle error
						alert('Error sending message');

					}
				});
			}
		}
	</script>

	<script>
		// Th√™m h√†m ƒë·ªÉ x·ª≠ l√Ω s·ª± ki·ªán click v√†o icon
		function addEmojiToContent(emoji) {
			// L·∫•y gi√° tr·ªã hi·ªán t·∫°i c·ªßa n·ªôi dung
			var currentContent = document.getElementById('content').value;
			// Th√™m emoji v√†o n·ªôi dung
			var newContent = currentContent + emoji;
			// G√°n gi√° tr·ªã m·ªõi cho n·ªôi dung
			document.getElementById('content').value = newContent;
		}
	</script>

</head>

<body>

	<!-- Hi·ªÉn th·ªã tin nh·∫Øn t·ª´ Firebase v√† c∆° s·ªü d·ªØ li·ªáu JPA -->
	<!--<div id="Receiver-Name">
	</div>
	<div id="chat-container">

		<div id="chat"></div>

	</div>-->





	<div class="tab-content messenger">
		<div class="tab-pane active fade show " id="link1">
			<div class="row merged">
				<div class="col-lg-12">
					<div class="mesg-area-head">
						<div class="active-user">
							<figure><img src="images/resources/friend-avatar3.jpg" alt="">
								<span class="status f-online"></span>
							</figure>
							<div>
								<h6 class="unread" id="Receiver-Name"></h6>
								<span>Online</span>
							</div>
						</div>
						<ul class="live-calls">
							<li class="audio-call"><span class="fa fa-phone"></span></li>
							<li class="video-call"><span class="fa fa-video"></span></li>
							<li class="uzr-info"><span class="fa fa-info-circle"></span></li>
							<li>
								<div class="dropdown">
									<button class="btn" data-toggle="dropdown" aria-haspopup="true"
										aria-expanded="false">
										<i class="ti-view-grid"></i>
									</button>
									<div class="dropdown-menu dropdown-menu-right">
										<a class="dropdown-item audio-call" href="#"><i
												class="ti-headphone-alt"></i>Voice Call</a>
										<a href="#" class="dropdown-item video-call"><i
												class="ti-video-camera"></i>Video Call</a>
										<hr>
										<a href="#" class="dropdown-item"><i class="ti-server"></i>Clear History</a>
										<a href="#" class="dropdown-item"><i class="ti-hand-stop"></i>Block Contact</a>
										<a href="#" class="dropdown-item"><i class="ti-trash"></i>Delete Contact</a>
									</div>
								</div>
							</li>
						</ul>
					</div>
				</div>
				<div class="col-lg-8 col-md-8">
					<div class="mesge-area">
						<ul id="chat" class="conversations ps-container ps-theme-default ps-active-y">

							<div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;">

								<div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
							</div>
							<div class="ps-scrollbar-y-rail" style="top: 0px; height: 488px; right: 0px;">
								<div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 340px;"></div>
							</div>

						</ul>
					</div>



					<div class="message-writing-box">
						<form id="messageForm" th:attr="data-userid=${userid}" onsubmit="sendMessage(); return false;">
							<div class="text-area">
								<input type="text" id="content" name="content" placeholder="write your message here..">
								<button type="submit" id="sendButton"><i class="fa fa-paper-plane-o"></i></button>
							</div>

							<div class="emojies">
								<i><img src="images/smiles/happy-3.png" alt=""></i>
								<ul class="emojies-list">
									<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
												src="images/smiles/unhappy.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòõ')" role="button"><img
												src="images/smiles/tongue-out-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòí')" role="button"><img
												src="images/smiles/suspicious.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
												src="images/smiles/smiling.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòú')" role="button"><img
												src="images/smiles/wink.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòê')" role="button"><img
												src="images/smiles/bored.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò°')" role="button"><img
												src="images/smiles/angry-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò†')" role="button"><img
												src="images/smiles/angry.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòï')" role="button"><img
												src="images/smiles/bored-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòë')" role="button"><img
												src="images/smiles/bored-2.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòï')" role="button"><img
												src="images/smiles/confused-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòñ')" role="button"><img
												src="images/smiles/confused.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò≠')" role="button"><img
												src="images/smiles/crying-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
												src="images/smiles/crying.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò≥')" role="button"><img
												src="images/smiles/embarrassed.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòÄ')" role="button"><img
												src="images/smiles/emoticons.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòÉ')" role="button"><img
												src="images/smiles/happy-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòÑ')" role="button"><img
												src="images/smiles/happy-2.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
												src="images/smiles/happy-3.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòÜ')" role="button"><img
												src="images/smiles/happy-4.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò∑')" role="button"><img
												src="images/smiles/ill.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòç')" role="button"><img
												src="images/smiles/in-love.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòò')" role="button"><img
												src="images/smiles/kissing.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò†')" role="button"><img
												src="images/smiles/mad.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('ü§ì')" role="button"><img
												src="images/smiles/nerd.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üë∫')" role="button"><img
												src="images/smiles/ninja.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò∂')" role="button"><img
												src="images/smiles/quiet.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòû')" role="button"><img
												src="images/smiles/sad.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('ü§´')" role="button"><img
												src="images/smiles/secret.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
												src="images/smiles/smile.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòØ')" role="button"><img
												src="images/smiles/surprised-1.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòã')" role="button"><img
												src="images/smiles/tongue-out.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
												src="images/smiles/unhappy.png" alt=""></a></li>
									<li><a title="" onclick="addEmojiToContent('üòí')" role="button"><img
												src="images/smiles/suspicious.png" alt=""></a></li>

								</ul>
							</div>
							<div class="attach-file">
								<label class="fileContainer">
									<i class="ti-clip"></i>
									<input type="file">
								</label>
							</div>
						</form>
					</div>
					<div>
						<input type="text" id="userid" name="userid" placeholder="userid"
							th:value="${session.userInfoID}" hidden />
					</div>




				</div>
			</div>
		</div>
	</div>










	<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
	<script src="js/main.min.js"></script>
	<script src="js/script.js"></script>
	<div id="mm-blocker" class="mm-slideout"></div>

</body>

</html>