<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ALOHCMUTE</title>

	<link rel="stylesheet" href="/fontawesome-free-6.5.1-web/css/all.min.css" />
	<link rel="stylesheet" href="/fontawesome-free-6.5.1-web/css/styleAll.css" />
</head>

<body style="background-color: white">
	<div class="homePage">
		<div th:replace="~{menu::menu}"></div>
		<div id="listpost">
			<!--bắt đầu 1 post -->
			<div th:each="post : ${list}">
				<div th:replace="~{postTemplate::post(${post})}"></div>
			</div>
			<!--kết thúc 1 post -->
		</div>
		<div th:replace="~{asideMenu::asideMenu}"></div>

		<div class="modal js-modal">
			<div class="modal-container">
				<header class="modal-header">
					<a href="#">
						<i class="fa-regular fa-paper-plane list-item-icon"
							style="color: rgb(0, 0, 0); padding-left: 20px; padding-top: 20px"></i>
					</a>
					<h3>Create new post</h3>
					<button href="#" style="
                            background-color: #fff;
                            border: none;
                            cursor: pointer;
                            padding-bottom: 20px;
                            border-top-right-radius: 10px;
                        " class="js-modal-close">
						<i class="fa-solid fa-xmark" style="padding-right: 20px; padding-top: 20px"></i>
					</button>
				</header>
				<form >
				<div class="modal-body">
					
						<div class="modal-img" id="imageContainer">
						</div>
						<div class="modal-caption">
							<div class="modal-text">
								<div class="modal-account">
									<img th:src="${userInfo.avata}" alt="avatar con mèo" class="avatar" />
									<div class="account-name">
										<h5 th:text="${userInfo.fullName}">xiaoluan_2011</h5>
									</div>
								</div>
								<textarea name="caption" id="caption" cols="40" rows="10" style="
                                    border-bottom: 1px solid rgb(219, 219, 219);
                                    padding-left: 20px;
                                    padding-top: 20px;
                                " placeholder="Write a caption..."></textarea>
								<div class="modal-picture">
									<label class="modal-picture-select">
										<i class="ti-clip"></i>
										<input type="file" id="file" name="file">Select from computer
									</label>
								</div>
							</div>
						</div>
				</div>
				</form>
			</div>
		</div>

		<!--		<div class="loadComment js-comment">
			<div class="loadComment-container">
				<div class="loadComment-img">
					<img src="../photo/post.jpeg" alt="Bài post" />
				</div>
				<div class="loadComment-list">
					<header class="loadComment-header" style="position: sticky">
						<img src="../photo/post.jpeg" alt="avt" />
						<h5>Tên tài khoản</h5>
					</header>
					<div style="overflow: auto; height: 437px">
						<ul>
							<li class="notify-item" style="border: none; padding-top: 10px; padding-bottom: 10px">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
							<li class="notify-item" style="border: none">
								<img src="../photo/post.jpeg" alt="" style="height: 35px; width: 35px" />
								<div class="loadComment-info">
									<span class="description">
										<h5>xiaoluan_2011</h5>
										vừa theo dõi bạn
									</span>
									<p>
										<span style="color: rgb(115, 115, 115)">Just now</span>
										<button class="loadComment-button">
											<i class="fa-solid fa-ellipsis" style="color: rgb(115, 115, 115)"></i>
										</button>
									</p>
								</div>
							</li>
						</ul>
					</div>
					<div class="loadComment-footer">
						<div class="loadComment-icon">
							<i class="fa-regular fa-heart"></i>
							<i class="fa-regular fa-comment js-cmt"></i>
						</div>
						<div class="loadComment-input">
							<i class="fa-regular fa-face-smile"></i>
							<input type="text" placeholder="Add a comment..." />
							<button class="button">Post</button>
						</div>
					</div>
				</div>
			</div>
		</div>
-->
	</div>



	<!-----------------------------------------------------------script------------------------------------- -->
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script>

		function Post(postId) {

			$.ajax({
				type: 'POST',
				url: '/like/' + postId,
				success: function (response) {

					const str = '#likeCount' + postId;
					const likespan = $(str);
					const likeicon = $('#likeButton' + postId);
					likespan.text(response + "Likes")
					likespan.html(response + " Likes")
					likeicon.toggleClass("tym");
				},
				error: function () {
					alert('Error liking post');
				}
			});
		}

	</script>
	<script defer>

		function likePost(postId) {

			$.ajax({
				type: 'POST',
				url: '/like/' + postId,
				success: function (response) {

					const str = '#likeCount' + postId;
					const likespan = $(str);
					const likeicon = $('#likeButton' + postId);
					likespan.text(response + "Likes")
					likespan.html(response + " Likes")
					likeicon.toggleClass("tym");
				},
				error: function () {
					alert('Error liking post');
				}
			});
		}

		var page = 1;
		var loading = true;
		$(window).scroll(function () {
			var windowHeight = $(window).height();
			var documentHeight = $(document).height();
			var scrollTop = $(window).scrollTop();

			// Kiểm tra xem cuộn đến cuối trang
			if (scrollTop + windowHeight >= documentHeight - 50 && loading) {
				loading = false;
				console.log("Đã cuộn xuống cuối trang");
				loadAjax();
			}
		});

		function loadAjax() {
			console.log("/listpost/group/" + page);
			$.ajax({
				type: 'GET',
				url: '/listpost/group/' + page,  // Thay đổi đường dẫn API và tham số theo nhu cầu của bạn

				success: function (data) {
					console.log(data);
					if (data.trim() !== "") {
						console.log("data k null");
						loading = true;
						page++;
					} else {

						loading = false;
					}
					console.log(page);

					$("#listpost").append(data);
				},
				error: function (error) {
					alert("error")
					console.error('Error loading data:', error);
					loading = false;
				}
			});
		}




	</script>
	<script>
		const post = document.querySelector(".js-post");
		const modal = document.querySelector(".js-modal");
		const modalClose = document.querySelector(".js-modal-close");
		//const cmt = document.querySelector(".js-cmt");
		//const listComment = document.querySelector(".js-comment");

		function showPost() {
			modal.classList.add("open");
		}

		function hidePost() {
			modal.classList.remove("open");
		}

		//function showComment() {
		//listComment.classList.add("open");
		//}

		//function hideComment() {
		//	listComment.classList.remove("open");
		//}

		//cmt.addEventListener("click", showComment);
		//listComment.addEventListener("click", hideComment);

		post.addEventListener("click", showPost);
		modalClose.addEventListener("click", hidePost);
	</script>


	<!--Lưu ảnh,Post ảnh-->
	<script type="module">

		import {initializeApp} from "https://www.gstatic.com/firebasejs/9.0.1/firebase-app.js";
		import {getStorage, ref, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/9.0.1/firebase-storage.js";

		const firebaseConfig = {
			key: "AIzaSyAktz6fBLYH1GcUykJi8JF5WHwI6dNncuY",
			apiKey: "AIzaSyAktz6fBLYH1GcUykJi8JF5WHwI6dNncuY",
			authDomain: "chatrealtime-7e7e8.firebaseapp.com",
			databaseURL: "https://chatrealtime-7e7e8-default-rtdb.firebaseio.com",
			projectId: "chatrealtime-7e7e8",
			storageBucket: "chatrealtime-7e7e8.appspot.com",
			messagingSenderId: "206925157542",
			appId: "1:206925157542:web:7e254501d41af820ed9067",
			measurementId: "G-0PDLXSS9SN",
		};

		// Initialize Firebase
		const app = initializeApp(firebaseConfig);
		const storage = getStorage();

		// Add event listener for file input change
		const fileInput = document.getElementById("file");
		const imageContainer = document.getElementById("imageContainer");

		fileInput.addEventListener("change", async () => {
			const file = fileInput.files[0];

			// Check if a file is selected
			if (file) {
				// Upload the selected file to Firebase Storage
				const storageRef = ref(storage, file.name);
				try {
					const snapshot = await uploadBytes(storageRef, file);

					//console.log("Uploaded:", snapshot.totalBytes);

					// Get the download URL of the uploaded image
					const downloadURL = await getDownloadURL(storageRef);

					// Display the image on the page
					imageContainer.innerHTML = `<img src="${downloadURL}" alt="Uploaded Image" id = "urlImage" width="100%" height="100%" max-width="567" max-height="386">`;

				} catch (error) {

				}
			}
		});
	</script>
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script>
		function saveImage() {

			const image = document.getElementById("urlImage");
			const imageURL = image.src;
			const tagContent = document.getElementById("content");
			const content = tagContent.value;

			try {
				$.ajax({
					type: 'POST',

					url: "/post/1",

					data: JSON.stringify({"imageURL": imageURL, "content": content}), //Ép kiểu string để tránh bị đôir / thành %
					contentType: 'application/json',
					success: function () {
						alert('Save successfully');
					},
					error: function () {
						alert('Error save image');
					}
				});

			} catch (error) {
				console.error('Error uploading to Firebase Storage:', error);
			}

		}
	</script>
</body>

</html>